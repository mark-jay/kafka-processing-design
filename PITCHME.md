### Обзор. Компоненты системы процессинга

На верхнем уровне процессинг представляет собой

- tariff service
- 2-phase-commit coordinator
- 2-phase-commit participant поддерживающий prepare и commit(далее PCparticipant)
- 2-phase-commit participant поддерживающий только commit(далее Cparticipant)

---

### Компоненты. Tariff service

Тариф сервис, основные функции
- посчитать коммиссии, кэшбеки
- сформировать запрос в 2-phase-commit coordinator


---

### Компоненты. Tariff service

Пример запроса:

"платеж на алтел 100 тг от пользователя 77071234567 через апи /payments/epay/utilities с карты XXXX "

---

### Компоненты. Tariff service

Пример ответа:

1. Mfs: списать 110 с пользователя 77071234567
2. Mfs: начислить 100 пользователю 77077654321
3. Mfs: начислить 10 пользователю 77070987654
4. Epay: провести транзакцию с карты XXXX на карту YYYY
5. Hermes: провести платеж на аккаунт алтел с номером счета = ZZZ

---

### Компоненты. 2-phase-commit coordinator

Цель: гарантировать что все части транзакции пройдут, либо все отклонятся.
Требования: может быть сколько угодно PCparticipants + не более одного Cparticipant

---

### Компоненты. 2-phase-commit coordinator

Алгоритм:

1. Разослать PCparticipant'ам 'prepare'
2. Если хотя бы один ответил fail, то слать всем abort
3. Иначе выслать запрос единственному Cparticipant
4. Если ответ fail то слать всем abort
5. Иначе - разослать всем commit

---

### Компоненты. PCparticipants. Интерфейс

Каждый участник представляет собой:

- отдельное приложение(отдельный application_id в kafka-streams)
- своя собственная модель запроса(могут содержаться кошельки, номера банковских карт и тд)
- должны поддерживать 3 операции: prepare, commit, abort

---

### Компоненты. PCparticipants. Интерфейс

Операции подробнее:

- prepare - блокировка денег. Операция может завершиться успешно или нет
- commit - завершение транзакции. После prepare и гарантирует успешное завершение.
- abort - зарблокировка денег. После prepare и гарантирует успешное завершение.

---

### Компоненты. PCparticipants. Примеры в текущей системе

- сервис mfs который делает движение денег на заданном аккаунте(одном)
- epay

---

### Компоненты. Компоненты системы процессинга

Обработка платежа:

- запрос приходит на tariff service
- tariff service разбивает в удобном виде для того чтобы передать это 2-phase-commit coordinator'у

---

### Компоненты. Компоненты системы процессинга
