### Обзор. Компоненты системы процессинга

На верхнем уровне процессинг представляет собой

- tariff service
- 2-phase-commit coordinator
- 2-phase-commit participant поддерживающий prepare и commit(далее PCparticipant)
- 2-phase-commit participant поддерживающий только commit(далее Cparticipant)

---

### Компоненты. Tariff service

Тариф сервис, основные функции
- посчитать коммиссии, кэшбеки
- сформировать запрос в 2-phase-commit coordinator


---

### Компоненты. Tariff service

Пример запроса:

"платеж на алтел 100 тг от пользователя 77071234567 через апи /payments/epay/utilities с карты XXXX "

---

### Компоненты. Tariff service

Пример ответа:

1. Mfs: списать 110 с пользователя 77071234567
2. Mfs: начислить 100 пользователю 77077654321
3. Mfs: начислить 10 пользователю 77070987654
4. Epay: провести транзакцию с карты XXXX на карту YYYY
5. Hermes: провести платеж на аккаунт алтел с номером счета = ZZZ

---

### Компоненты. 2-phase-commit coordinator

Цель: гарантировать что все части транзакции пройдут, либо все отклонятся.
Требования: может быть сколько угодно PCparticipants + не более одного Cparticipant

---

### Компоненты. 2-phase-commit coordinator

Алгоритм:

1. Разослать всем PCparticipants сообщение prepare
2. Если хотя бы один ответил fail, то разослать всем abort и закончить на этом
3. Если все ответили prepared, выслать запрос единственному Cparticipant
4. Если единственный Cparticipant ответил fail то разослать всем abort и закончить на этом
5. Если Cparticipant ответил успешно, либо он отстутствует - разослать всем commit и закончить на этом.

---

### Компоненты. PCparticipants. Интерфейс

Каждый участник представляет собой:

- отдельное приложение(отдельный application_id в kafka-streams)
- своя собственная моделью запроса(могут содержаться кошельки, номера банковских карт и тд)
- должны поддерживать 3 операции: prepare, commit, abort

---

### Компоненты. PCparticipants. Интерфейс

Операции подробнее:

- prepare - блокировка денег. Операция может завершиться успешно или нет
- commit - завершение транзакции. Commit всегда вызывается после успешного prepare и должно гарантировать успешное завершение
- abort - зарблокировка денег. Abort всегда вызывается после успешного prepare и должно гарантировать успешное завершение

---

### Компоненты. PCparticipants. Примеры в текущей системе

- сервис mfs который делает движение денег на заданном аккаунте(одном)
- epay

---

### Компоненты. Компоненты системы процессинга

Обработка платежа:

- запрос приходит на tariff service
- tariff service разбивает в удобном виде для того чтобы передать это 2-phase-commit coordinator'у

---

### Компоненты. Компоненты системы процессинга
