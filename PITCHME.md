### Обзор. Компоненты системы процессинга

На верхнем уровне процессинг представляет собой

- tariff service
- 2-phase-commit coordinator
- 2-phase-commit participant поддерживающий prepare и commit(далее PCparticipant)
- 2-phase-commit participant поддерживающий только commit(далее Cparticipant)

---

### Компоненты. Tariff service

Тариф сервис, основные функции
- посчитать коммиссии, кэшбеки
- сформировать запрос в 2-phase-commit coordinator


---

### Компоненты. Tariff service

Пример запроса с очереди в кафке, ключ=ID запроса:

"платеж на алтел 100 тг от пользователя 77071234567 через апи /payments/epay/utilities с карты XXXX "

---

### Компоненты. Tariff service

Пример ответа(выходная очередь в кафке, ключ = ID запроса):

1. Mfs: списать 110 с пользователя 77071234567
2. Mfs: начислить 100 пользователю 77077654321
3. Mfs: начислить 10 пользователю 77070987654
4. Epay: провести транзакцию с карты XXXX на карту YYYY
5. Hermes: провести платеж на аккаунт алтел с номером счета = ZZZ

---

### Компоненты. 2-phase-commit coordinator

Цель: гарантировать что все части транзакции пройдут, либо все отклонятся.
Требования: может быть сколько угодно PCparticipants + не более одного Cparticipant

---

### Компоненты. 2-phase-commit coordinator

Алгоритм:

1. Разослать PCparticipant'ам 'prepare'
2. Если хотя бы один ответил fail, то слать всем abort
3. Иначе выслать запрос единственному Cparticipant
4. Если ответ fail то слать всем abort
5. Иначе - разослать всем commit


---

### Компоненты. 2-phase-commit coordinator

- Рассылка prepare/commit/abort происходит каждый в свою очередь по ключу = ID распределенной транзакции.
- Принятие ответов от prepare происходит в одну очередь по ключу = ID распределенной транзакции
(чтобы обрабатывать данные по одному платежу последовательно) и складываться в локальный KTable

---

### Компоненты. 2-phase-commit coordinator

- Гарантируется что за prepare-сообщением последует ровно одно сообщение(commit либо abort)
- Масштабирование достигается за счет того что обработка транзакций друг от друга не зависит и последовательность требуется только в обработке данных по одному платежу.

---

### Компоненты. PCparticipants. Интерфейс

Каждый участник представляет собой:

- отдельное приложение(отдельный application_id в kafka-streams)
- своя собственная модель запроса(могут содержаться кошельки, номера банковских карт и тд)
- должны поддерживать 3 операции: prepare, commit, abort

---

### Компоненты. PCparticipants. Интерфейс

Операции подробнее:

- prepare - блокировка денег. Операция может завершиться успешно или нет
- commit - завершение транзакции. После prepare и гарантирует успешное завершение.
- abort - зарблокировка денег. После prepare и гарантирует успешное завершение.

---

### Компоненты. PCparticipants. Примеры в текущей системе

- сервис mfs который делает движение денег на заданном аккаунте(одном)
- epay

---

### Компоненты. Cparticipants. Интерфейс

- pay метод который отвечает успехом или неудачей.

---

### Компоненты. Cparticipants. Примеры в текущей системе

- ACB cashout
- epay cashout
- utilities
- webshop(в каком-то смысле)

---

### Компоненты. PCparticipants. MFS. Шаг1

Принимает запрос к примеру:
- аккаунт XXX,
- номер транзакции = YYY
- -100, "оплата услуг"
- +10, "кэшбэк"

---

### Компоненты. PCparticipants. MFS. Шаг2

- Проверяет настроенные лимиты и сохраняет запись в KTable оригинальный запрос + текущие значения лимитов для будущего аудита.
Запись происходит по ключу = ID локальной транзакции
- Генерируется prepare ивент в отдельный топик, который слушают все лимитеры. Ключ=ID локальной транзакции.

---

### Компоненты. PCparticipants. MFS. Шаг2

Пример записи в KTable:
- TransactionId=XXX
- MaxLimiter(max value=100000, current_value=null)

---
- MinLimiter(max value=0, current_value=null)

### Компоненты. PCparticipants. MFS. Шаг3

Далее MFS слушает ответы от лимитеров игнорируя те которые ему не интересны и обновляя данные там где необходимо.
Как только все ответы получены, запись будет выглядеть как:

- TransactionId=XXX
- MaxLimiter(max value=100000, current_value=1561)
- MinLimiter(max value=0, current_value=1612)

---

### Компоненты. PCparticipants. MFS. Шаг4

Как только ответы от необходимых лимитеров собраны генерируется ответ компоненту 2pc-coordinator:
- prepared
- failed

---

### Компоненты. PCparticipants. MFS. Шаг5

Далее ожидается ответ в виде commit или abort, который будет перенаправлен лимитерам для дальнейших действий

---

### Компоненты. PCparticipants. MFS. Limiters

Работа лимитеров состоит исключительно из обновления в качестве реакций на prepare/commit/abort событий от MFS компопента.
